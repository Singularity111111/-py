import pandas as pd
import glob
import os
import numpy as np

# ==================== é…ç½®åŒº ====================
EXCHANGE_RATE = 280
SEARCH_PATH = "." 
# ================================================

def clean_and_prepare_data(df):
    """æ•°æ®æ¸…æ´—å’Œé¢„å¤„ç†å‡½æ•°"""
    df.columns = [str(col).replace(' (%)', '_pct').replace(' ', '_') for col in df.columns]
    for col in df.columns:
        if col in ['æ—¥æœŸ', 'æ¸ é“æ¥æº']:
            continue
        df[col] = pd.to_numeric(df[col], errors='coerce')
    df.fillna(0, inplace=True)
    return df

def calculate_ratios_and_convert_currency(summary_df):
    """æ ¹æ®èšåˆåçš„æ•°æ®ï¼Œé‡æ–°è®¡ç®—æ¯”ç‡å‹æŒ‡æ ‡å¹¶è½¬æ¢æ±‡ç‡ (é€‚ç”¨äºä»»ä½•è¡Œ)"""
    df = summary_df.copy()
    print("  æ­£åœ¨é‡æ–°è®¡ç®—æ¯”ç‡å¹¶è½¬æ¢æ±‡ç‡...")
    
    # åŸºç¡€æ•°å€¼åˆ—
    sum_cols = ['æ–°å¢ç”¨æˆ·æ•°', 'æ—¥æ´»è·ƒç©å®¶æ•°', 'å……å€¼äººæ•°', 'å……å€¼é‡‘é¢', 'æç°é‡‘é¢', 'é¦–å­˜äººæ•°', 'æ–°å¢ä»˜è´¹äººæ•°']
    # ç¡®ä¿åˆ—å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„åˆ—ä»¥0å¡«å……
    for col in sum_cols:
        if col not in df.columns:
            df[col] = 0

    # é‡æ–°è®¡ç®—æ‰€æœ‰æ¯”ç‡
    with np.errstate(divide='ignore', invalid='ignore'):
        df['å……å‡æ'] = df['å……å€¼é‡‘é¢'] - df['æç°é‡‘é¢']
        df['ç›ˆä½™ç‡_pct'] = np.divide(df['å……å‡æ'], df['å……å€¼é‡‘é¢']) * 100
        df['é¦–å­˜ä»˜è´¹ç‡_pct'] = np.divide(df['é¦–å­˜äººæ•°'], df['æ–°å¢ç”¨æˆ·æ•°']) * 100
        df['æ–°å¢ä»˜è´¹ç‡_pct'] = np.divide(df['æ–°å¢ä»˜è´¹äººæ•°'], df['æ–°å¢ç”¨æˆ·æ•°']) * 100
        df['ä»˜è´¹ç‡_pct'] = np.divide(df['å……å€¼äººæ•°'], df['æ—¥æ´»è·ƒç©å®¶æ•°']) * 100
        df['ARPPU'] = np.divide(df['å……å€¼é‡‘é¢'], df['å……å€¼äººæ•°'])
        df['ARPU'] = np.divide(df['å……å€¼é‡‘é¢'], df['æ—¥æ´»è·ƒç©å®¶æ•°'])
    
    df.replace([np.inf, -np.inf], 0, inplace=True)
    df.fillna(0, inplace=True)

    # è½¬æ¢æ±‡ç‡
    currency_cols = ['å……å€¼é‡‘é¢', 'æç°é‡‘é¢', 'å……å‡æ', 'é¦–å­˜å……å€¼é‡‘é¢', 'æ–°å¢å……å€¼é‡‘é¢', 'è€ç”¨æˆ·å……å€¼é‡‘é¢', 'è€ç”¨æˆ·æç°é‡‘é¢', 'ARPPU', 'ARPU']
    for col in currency_cols:
        if col in df.columns:
            df[col] = df[col] / EXCHANGE_RATE
            
    return df

def process_report_file(file_path, is_aggregated=False):
    """
    ç»Ÿä¸€å¤„ç†æ‰€æœ‰æŠ¥è¡¨æ–‡ä»¶ã€‚
    - å¦‚æœæ˜¯æ—¥æŠ¥/å‘¨æŠ¥/æœˆæŠ¥æ–‡ä»¶, is_aggregated=False, ä¼šæŒ‰å¤©èšåˆã€‚
    - å¦‚æœæ˜¯æ€»è®¡è¡Œ, is_aggregated=True, ä¼šç›´æ¥å¤„ç†ã€‚
    """
    print(f"æ­£åœ¨å¤„ç†æ–‡ä»¶: {os.path.basename(file_path)}")
    try:
        df = pd.read_excel(file_path)
    except Exception as e:
        print(f"è¯»å–æ–‡ä»¶ '{os.path.basename(file_path)}' å¤±è´¥: {e}")
        return None

    df = clean_and_prepare_data(df)
    
    # å®šä¹‰éœ€è¦ç›´æ¥ç›¸åŠ çš„åŸºç¡€åˆ—
    sum_cols = ['æ–°å¢æ³¨å†Œè®¾å¤‡', 'æ–°å¢ç”¨æˆ·æ•°', 'æ—¥æ´»è·ƒç©å®¶æ•°', 'è€ç©å®¶æ—¥æ´»', 'å……å€¼äººæ•°', 'å……å€¼é‡‘é¢', 'æç°é‡‘é¢', 'é¦–å­˜äººæ•°', 'é¦–å­˜å……å€¼é‡‘é¢', 'æ–°å¢ä»˜è´¹äººæ•°', 'æ–°å¢å……å€¼é‡‘é¢', 'è€ç”¨æˆ·å……å€¼äººæ•°', 'è€ç”¨æˆ·å……å€¼é‡‘é¢', 'è€ç”¨æˆ·æç°é‡‘é¢']
    sum_cols_exist = [col for col in sum_cols if col in df.columns]

    # æŒ‰å¤©èšåˆæ‰€æœ‰æ¸ é“
    daily_grouped = df.groupby('æ—¥æœŸ')[sum_cols_exist].sum().reset_index()
    
    # ä¸ºæ¯ä¸€å¤©é‡æ–°è®¡ç®—æ¯”ç‡å’Œè½¬æ¢æ±‡ç‡
    final_df = calculate_ratios_and_convert_currency(daily_grouped)

    # å¦‚æœæ˜¯å‘¨æŠ¥æˆ–æœˆæŠ¥ï¼Œé¢å¤–è®¡ç®—å¹¶æ·»åŠ æ€»è®¡è¡Œ
    if is_aggregated:
        print("  æ­£åœ¨è®¡ç®—æ€»è®¡è¡Œ...")
        # è®¡ç®—æ€»è®¡
        total_summary = pd.DataFrame(daily_grouped[sum_cols_exist].sum()).T
        # ä¸ºæ€»è®¡è¡Œé‡æ–°è®¡ç®—æ¯”ç‡å’Œè½¬æ¢æ±‡ç‡
        total_row = calculate_ratios_and_convert_currency(total_summary)
        total_row['æ—¥æœŸ'] = 'æ€»è®¡' # æ ‡è®°ä¸ºæ€»è®¡è¡Œ
        # å°†æ€»è®¡è¡Œæ‹¼æ¥åˆ°æ•°æ®æœ«å°¾
        final_df = pd.concat([final_df, total_row], ignore_index=True)

    return final_df

# --- ä¸»ç¨‹åº ---
def main():
    print("--- æŠ¥è¡¨ç”Ÿæˆå™¨å¼€å§‹è¿è¡Œ ---")
    
    all_files = os.listdir(SEARCH_PATH)
    daily_files = [f for f in all_files if f.startswith('æ—¥æŠ¥_') and f.endswith('.csv')]
    weekly_files = [f for f in all_files if f.startswith('WeeklyæŠ¥_') and f.endswith('.csv')]
    monthly_files = [f for f in all_files if f.startswith('MonthlyæŠ¥_') and f.endswith('.csv')]
    
    output_filename = 'æœ€ç»ˆç”ŸæˆæŠ¥è¡¨.xlsx'
    with pd.ExcelWriter(output_filename, engine='xlsxwriter') as writer:
        print("\n--- å¼€å§‹å¤„ç†æ—¥æŠ¥ ---")
        if not daily_files:
            print("è­¦å‘Šï¼šæœªæ‰¾åˆ°æ—¥æŠ¥æ–‡ä»¶ã€‚")
        else:
            latest_file = max(daily_files, key=lambda f: os.path.getctime(os.path.join(SEARCH_PATH, f)))
            df = process_report_file(latest_file, is_aggregated=False)
            if df is not None:
                df.to_excel(writer, sheet_name='æ¯æ—¥æ€»è§ˆ', index=False)
                print("æ¯æ—¥æ€»è§ˆå·²å†™å…¥Excelã€‚")

        print("\n--- å¼€å§‹å¤„ç†å‘¨æŠ¥ ---")
        if not weekly_files:
            print("è­¦å‘Šï¼šæœªæ‰¾åˆ°å‘¨æŠ¥æ–‡ä»¶ã€‚")
        else:
            latest_file = max(weekly_files, key=lambda f: os.path.getctime(os.path.join(SEARCH_PATH, f)))
            df = process_report_file(latest_file, is_aggregated=True) # ä¼ å…¥is_aggregated=True
            if df is not None:
                df.to_excel(writer, sheet_name='æ¯å‘¨æ€»è§ˆ', index=False)
                print("æ¯å‘¨æ€»è§ˆå·²å†™å…¥Excelã€‚")

        print("\n--- å¼€å§‹å¤„ç†æœˆæŠ¥ ---")
        if not monthly_files:
            print("è­¦å‘Šï¼šæœªæ‰¾åˆ°æœˆæŠ¥æ–‡ä»¶ã€‚")
        else:
            latest_file = max(monthly_files, key=lambda f: os.path.getctime(os.path.join(SEARCH_PATH, f)))
            df = process_report_file(latest_file, is_aggregated=True) # ä¼ å…¥is_aggregated=True
            if df is not None:
                df.to_excel(writer, sheet_name='æ¯æœˆæ€»è§ˆ', index=False)
                print("æ¯æœˆæ€»è§ˆå·²å†™å…¥Excelã€‚")

    print("\n" + "="*50)
    print(f"ğŸ‰ å…¨éƒ¨æŠ¥è¡¨ç”ŸæˆæˆåŠŸï¼è¯·åœ¨å½“å‰æ–‡ä»¶å¤¹æŸ¥çœ‹æ–‡ä»¶: {output_filename}")
    print("="*50)

if __name__ == '__main__':
    main()

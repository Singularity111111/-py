import time
import os
import glob
from datetime import date
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options

# ==================== é…ç½®åŒº ====================
CHROMEDRIVER_PATH = r"C:\Users\User\Downloads\chromedriver-win64\chromedriver-win64\chromedriver.exe"
LOGIN_URL = "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/login"
USERNAME = "Touhou002"
PASSWORD = "123456"
# ================================================

def find_and_rename_newest_file(download_path, report_name, existing_files):
    """æŸ¥æ‰¾æœ€æ–°ä¸‹è½½çš„æ–‡ä»¶å¹¶æ ¹æ®æŠ¥è¡¨åç§°é‡å‘½å"""
    print(f"  ç­‰å¾… '{report_name}' æ–‡ä»¶ä¸‹è½½å®Œæˆ...")
    time.sleep(20) # ä¸ºä¸‹è½½å¤§æ–‡ä»¶é¢„ç•™è¶³å¤Ÿæ—¶é—´
    
    current_files = set(glob.glob(os.path.join(download_path, '*.xlsx')) + glob.glob(os.path.join(download_path, '*.csv')))
    new_files = current_files - existing_files
    
    if not new_files:
        print(f"  [è­¦å‘Š] æœªæ‰¾åˆ°ä¸º '{report_name}' ä¸‹è½½çš„æ–°æ–‡ä»¶ï¼")
        return
    
    newest_file = new_files.pop()
    today_str = date.today().strftime('%Y-%m-%d')
    new_filename = f"download_{report_name}_{today_str}.csv"
    new_filepath = os.path.join(download_path, new_filename)
    
    if os.path.exists(new_filepath):
        os.remove(new_filepath)
    os.rename(newest_file, new_filepath)
    print(f"  [æˆåŠŸ] æ–‡ä»¶å·²é‡å‘½åä¸º: {new_filename}")

def download_report(driver, wait, report_config):
    """ä¸€ä¸ªé€šç”¨çš„å‡½æ•°ï¼Œç”¨äºç‚¹å‡»èœå•ã€è®¾ç½®æ—¥æœŸå¹¶å¯¼å‡ºæŠ¥è¡¨"""
    print(f"\n--- æ­£åœ¨å¤„ç†: {report_config['name']} ---")
    
    # 1. ç‚¹å‡»å­èœå•
    print(f"  ç‚¹å‡»å­èœå•: {report_config['name']}...")
    menu_item = wait.until(EC.element_to_be_clickable((By.XPATH, report_config['menu_xpath'])))
    driver.execute_script("arguments[0].click();", menu_item)
    time.sleep(3)

    # 2. ç‚¹å‡»ã€è¿‘90å¤©ã€‘
    print("  ç‚¹å‡»ã€è¿‘90å¤©ã€‘æ—¶é—´èŒƒå›´...")
    days_tab_xpath = "//span[text()='è¿‘90å¤©']"
    ninety_days_button = wait.until(EC.element_to_be_clickable((By.XPATH, days_tab_xpath)))
    driver.execute_script("arguments[0].click();", ninety_days_button)
    
    # 3. ç­‰å¾…æ•°æ®åŠ è½½
    print("  ç­‰å¾…æ•°æ®åˆ·æ–°ï¼ˆ15ç§’ï¼‰...")
    time.sleep(15)

    # 4. å¯¼å‡º
    downloads_path = os.path.join(os.path.expanduser('~'), 'Downloads')
    existing_files = set(glob.glob(os.path.join(downloads_path, '*.xlsx')) + glob.glob(os.path.join(downloads_path, '*.csv')))
    
    print("  ç‚¹å‡»'å¯¼å‡º'æŒ‰é’®...")
    export_button_xpath = "//button[contains(., 'å¯¼å‡º')]"
    export_button = wait.until(EC.element_to_be_clickable((By.XPATH, export_button_xpath)))
    driver.execute_script("arguments[0].click();", export_button)
    
    # 5. é‡å‘½å
    find_and_rename_newest_file(downloads_path, report_config['name'], existing_files)

# --- ä¸»ç¨‹åº ---
print("--- å…¨èƒ½æ•°æ®ä¸‹è½½å™¨å¼€å§‹è¿è¡Œ (v6.1 - æœ€ç»ˆä¿®æ­£ç‰ˆ) ---")
s = Service(CHROMEDRIVER_PATH)
chrome_options = Options()
chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
chrome_options.add_experimental_option('useAutomationExtension', False)
chrome_options.add_argument('user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36')
chrome_options.add_argument('--disable-blink-features=AutomationControlled')

try:
    driver = webdriver.Chrome(service=s, options=chrome_options)
    wait = WebDriverWait(driver, 30)
    driver.get(LOGIN_URL)
    
    print("é¡µé¢åŠ è½½ä¸­ï¼Œç­‰å¾…ç™»å½•æ¡†...")
    wait.until(EC.presence_of_element_located((By.XPATH, "//input[@placeholder='è´¦æˆ·']"))).send_keys(USERNAME)
    driver.find_element(By.XPATH, "//input[@placeholder='å¯†ç ']").send_keys(PASSWORD)
    driver.find_element(By.XPATH, "//button[contains(., 'ç™»å½•')]").click()
    
    print("\n" + "="*50 + "\nè„šæœ¬å·²æš‚åœï¼è¯·æ‰‹åŠ¨è¾“å…¥è°·æ­ŒéªŒè¯ç å¹¶å®Œæˆç™»å½•ã€‚")
    input("ç™»å½•æˆåŠŸåï¼Œè¯·å›åˆ°æ­¤çª—å£ï¼ŒæŒ‰ Enter (å›è½¦) é”®ç»§ç»­...")
    print("\n" + "="*50 + "\nè„šæœ¬å·²æ¢å¤ï¼Œå¼€å§‹åˆ†æ­¥ä¸‹è½½æ•°æ®æº...")

    path1_reports = [
        {"name": "æ¸ é“æŠ¥è¡¨", "menu_xpath": "//span[contains(., 'æ—¥æ•°æ®æ¦‚è§ˆ_æ¸ é“æŠ¥è¡¨')]"},
        {"name": "è¿è¥æŠ¥è¡¨", "menu_xpath": "//span[contains(., 'æ—¥æ•°æ®æ¦‚è§ˆ')]"},
    ]
    path2_reports = [
        {"name": "é¦–å……ç”¨æˆ·åˆ†æ", "menu_xpath": "//span[contains(., 'é¦–å……ç”¨æˆ·åˆ†æ')]"},
        {"name": "é¦–å……ç”¨æˆ·LTV", "menu_xpath": "//span[contains(., 'é¦–å……ç”¨æˆ·LTV')]"} 
    ]
    
    print("\n=== å¼€å§‹æ‰§è¡Œè·¯å¾„1ï¼šä¸‹è½½ç›´æ¥å¯è§çš„æŠ¥è¡¨ ===")
    for report_config in path1_reports:
        try:
            download_report(driver, wait, report_config)
        except Exception as e:
            print(f"  [ä¸¥é‡é”™è¯¯] ä¸‹è½½ '{report_config['name']}' å¤±è´¥: {e}")
            driver.refresh()
            time.sleep(5)

    print("\n=== å¼€å§‹æ‰§è¡Œè·¯å¾„2ï¼šä¸‹è½½éœ€ç‚¹å‡»çˆ¶èœå•çš„æŠ¥è¡¨ ===")
    try:
        player_analysis_xpath = "//span[contains(., 'ç©å®¶åˆ†æ')]"
        print(f"  ç‚¹å‡»ä¸€æ¬¡çˆ¶èœå•: ã€ç©å®¶åˆ†æã€‘...")
        parent_menu = wait.until(EC.element_to_be_clickable((By.XPATH, player_analysis_xpath)))
        driver.execute_script("arguments[0].click();", parent_menu)
        time.sleep(2)

        for report_config in path2_reports:
            try:
                download_report(driver, wait, report_config)
            except Exception as e:
                print(f"  [ä¸¥é‡é”™è¯¯] ä¸‹è½½ '{report_config['name']}' å¤±è´¥: {e}")
    except Exception as e:
        print(f"  [ä¸¥é‡é”™è¯¯] ç‚¹å‡»çˆ¶èœå•ã€ç©å®¶åˆ†æã€‘å¤±è´¥: {e}")

    print("\n" + "="*50)
    print("ğŸ‰ å…¨éƒ¨æ•°æ®æºä¸‹è½½å®Œæˆï¼")
    print("="*50)

except Exception as e:
    print(f"\nè„šæœ¬è¿è¡Œä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯: {e}")
finally:
    if 'driver' in locals() and driver:
        driver.quit()
    print("--- è„šæœ¬è¿è¡Œç»“æŸ ---")

import time
import os
import glob
from datetime import datetime, timedelta, date
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options

# ==================== é…ç½®åŒº ====================
CHROMEDRIVER_PATH = r"C:\Users\User\Downloads\chromedriver-win64\chromedriver-win64\chromedriver.exe"
LOGIN_URL = "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/login"
USERNAME = "Touhou002"
PASSWORD = "123456"
# ================================================

def find_and_rename_newest_file(download_path, report_type, start_date_str, end_date_str, existing_files):
    """æŸ¥æ‰¾æœ€æ–°ä¸‹è½½çš„æ–‡ä»¶å¹¶æ ¹æ®æŠ¥è¡¨ç±»å‹é‡å‘½å"""
    print(f"  ç­‰å¾…'{report_type}'æŠ¥è¡¨æ–‡ä»¶ä¸‹è½½å®Œæˆ...")
    time.sleep(15)
    
    current_files = set(glob.glob(os.path.join(download_path, '*.xlsx')) + glob.glob(os.path.join(download_path, '*.csv')))
    new_files = current_files - existing_files
    
    if not new_files:
        print(f"  [è­¦å‘Š] æœªæ‰¾åˆ°ä¸º {report_type} ä¸‹è½½çš„æ–°æ–‡ä»¶ï¼")
        return
    
    newest_file = new_files.pop()
    if report_type == "daily":
        new_filename = f"æ—¥æŠ¥_{start_date_str}.csv"
    else:
        new_filename = f"{report_type.capitalize()}æŠ¥_{start_date_str}_to_{end_date_str}.csv"
        
    new_filepath = os.path.join(download_path, new_filename)
    
    if os.path.exists(new_filepath): os.remove(new_filepath)
    os.rename(newest_file, new_filepath)
    print(f"  [æˆåŠŸ] æ–‡ä»¶å·²é‡å‘½åä¸º: {new_filename}")

# --- ä¸»ç¨‹åº ---
print("--- 'ä¸‰åˆä¸€'æŠ¥è¡¨æœ€ç»ˆç‰ˆè„šæœ¬å¼€å§‹è¿è¡Œ ---")
s = Service(CHROMEDRIVER_PATH)
chrome_options = Options()
# (ä¼ªè£…é€‰é¡¹)
chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
chrome_options.add_experimental_option('useAutomationExtension', False)
chrome_options.add_argument('user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36')
chrome_options.add_argument('--disable-blink-features=AutomationControlled')

try:
    driver = webdriver.Chrome(service=s, options=chrome_options)
    wait = WebDriverWait(driver, 20)
    driver.get(LOGIN_URL)
    
    # (ç™»å½•)
    print("é¡µé¢åŠ è½½ä¸­ï¼Œç­‰å¾…ç™»å½•æ¡†...")
    username_input = wait.until(EC.presence_of_element_located((By.XPATH, "//input[@placeholder='è´¦æˆ·']")))
    password_input = driver.find_element(By.XPATH, "//input[@placeholder='å¯†ç ']")
    login_button = driver.find_element(By.XPATH, "//button[contains(., 'ç™»å½•')]")
    print("æ­£åœ¨è¾“å…¥è´¦å·å¯†ç å¹¶ç™»å½•...")
    username_input.send_keys(USERNAME)
    password_input.send_keys(PASSWORD)
    login_button.click()
    
    # (æ‰‹åŠ¨éªŒè¯)
    print("\n" + "="*50 + "\nè„šæœ¬å·²æš‚åœï¼è¯·æ‰‹åŠ¨è¾“å…¥è°·æ­ŒéªŒè¯ç å¹¶å®Œæˆç™»å½•ã€‚")
    input("ç™»å½•æˆåŠŸåï¼Œè¯·å›åˆ°æ­¤çª—å£ï¼ŒæŒ‰ Enter (å›è½¦) é”®ç»§ç»­...")
    print("\n" + "="*50 + "\nè„šæœ¬å·²æ¢å¤ï¼Œå¼€å§‹æ‰¹é‡ä¸‹è½½ä»»åŠ¡...")

    # (è·³è½¬)
    report_url = "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/stat/dailySummaryChannel"
    print(f"ç›´æ¥è·³è½¬åˆ°æŠ¥è¡¨é¡µé¢...")
    driver.get(report_url)
    
    print("æˆåŠŸè¿›å…¥æŠ¥è¡¨é¡µé¢ï¼")
    time.sleep(5)

    downloads_path = os.path.join(os.path.expanduser('~'), 'Downloads')
    report_types_to_download = ["daily", "weekly", "monthly"]
    for report_type in report_types_to_download:
        print(f"\n--- æ­£åœ¨å¤„ç†: {report_type.upper()} æŠ¥è¡¨ ---")
        
        # === ç»ˆæä¿®æ­£ï¼šæ ¹æ®ä½ çš„å»ºè®®ï¼Œä½¿ç”¨å¿«æ·æŒ‰é’®ï¼Œå¹¶åˆ é™¤æŸ¥è¯¢æŒ‰é’® ===
        if report_type == "daily":
            start_date = date.today() - timedelta(days=1)
            end_date = start_date
            start_date_str = start_date.strftime('%Y-%m-%d')
            end_date_str = end_date.strftime('%Y-%m-%d')
            print(f"  è®¾ç½®æ—¥æœŸèŒƒå›´: {start_date_str} åˆ° {end_date_str}")
            start_date_input = wait.until(EC.presence_of_element_located((By.XPATH, "//input[@placeholder='å¼€å§‹æ—¥æœŸ']")))
            end_date_input = driver.find_element(By.XPATH, "//input[@placeholder='ç»“æŸæ—¥æœŸ']")
            start_date_input.clear(); time.sleep(0.5); start_date_input.send_keys(start_date_str)
            end_date_input.clear(); time.sleep(0.5); end_date_input.send_keys(end_date_str)
            driver.find_element(By.XPATH, "//body").click()
        
        elif report_type == "weekly":
            print("  ç‚¹å‡»ã€è¿‘7å¤©ã€‘å¿«æ·æŒ‰é’®...")
            wait.until(EC.element_to_be_clickable((By.XPATH, "//span[text()='è¿‘7å¤©']"))).click()
        
        elif report_type == "monthly":
            print("  ç‚¹å‡»ã€è¿‘30å¤©ã€‘å¿«æ·æŒ‰é’®...")
            wait.until(EC.element_to_be_clickable((By.XPATH, "//span[text()='è¿‘30å¤©']"))).click()

        # ç­‰å¾…ç‚¹å‡»å¿«æ·æŒ‰é’®æˆ–è¾“å…¥æ—¥æœŸåï¼Œæ•°æ®è‡ªåŠ¨åˆ·æ–°
        print("  ç­‰å¾…æ•°æ®åŠ è½½...")
        time.sleep(10) 
        
        # é‡æ–°è·å–æ—¥æœŸä»¥ç¡®ä¿æ–‡ä»¶åå‡†ç¡®
        start_date_str = driver.find_element(By.XPATH, "//input[@placeholder='å¼€å§‹æ—¥æœŸ']").get_attribute('value')
        end_date_str = driver.find_element(By.XPATH, "//input[@placeholder='ç»“æŸæ—¥æœŸ']").get_attribute('value')
        print(f"  ç¡®è®¤å®é™…æ—¥æœŸèŒƒå›´ä¸º: {start_date_str} åˆ° {end_date_str}")
        
        existing_files_before_download = set(glob.glob(os.path.join(downloads_path, '*.xlsx')) + glob.glob(os.path.join(downloads_path, '*.csv')))
        
        print("  æ­£åœ¨ç‚¹å‡»'å¯¼å‡º'æŒ‰é’®...")
        wait.until(EC.element_to_be_clickable((By.XPATH, "//button[contains(., 'å¯¼å‡º')]"))).click()
        
        find_and_rename_newest_file(downloads_path, report_type, start_date_str, end_date_str, existing_files_before_download)

    print("\n" + "="*50)
    print("ğŸ‰ å…¨éƒ¨ä»»åŠ¡æˆåŠŸï¼æ—¥æŠ¥ã€å‘¨æŠ¥ã€æœˆæŠ¥å‡å·²ä¸‹è½½å¹¶é‡å‘½åã€‚")
    print("="*50)

except Exception as e:
    print(f"\nè„šæœ¬è¿è¡Œä¸­å‘ç”Ÿé”™è¯¯: {e}")

finally:
    if 'driver' in locals() and driver:
        driver.quit()
    print("--- è„šæœ¬è¿è¡Œç»“æŸ ---")

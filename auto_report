import time
import os
import glob
from datetime import date, timedelta
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options

# ==================== é…ç½®åŒº ====================
CHROMEDRIVER_PATH = r"C:\Users\User\Downloads\chromedriver-win64\chromedriver-win64\chromedriver.exe"
LOGIN_URL = "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/login"
USERNAME = "Touhou002"
PASSWORD = "123456"


# ================================================

def find_and_rename_newest_file(download_path, report_name, existing_files):
    """
    [ä¼˜åŒ–] åœ¨æŒ‡å®šè¶…æ—¶æ—¶é—´å†…ï¼Œå¾ªç¯æŸ¥æ‰¾æœ€æ–°ä¸‹è½½çš„æ–‡ä»¶å¹¶æ ¹æ®æŠ¥è¡¨åç§°é‡å‘½åã€‚
    è¿™æ¯”å›ºå®šçš„`time.sleep()`æ›´å¯é ã€‚
    """
    print(f"  ç­‰å¾… '{report_name}' æ–‡ä»¶ä¸‹è½½å®Œæˆ...")
    timeout = 45  # ç­‰å¾…ä¸‹è½½çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    start_time = time.time()
    newest_file = None

    while time.time() - start_time < timeout:
        current_files = set(
            glob.glob(os.path.join(download_path, '*.xlsx')) + glob.glob(os.path.join(download_path, '*.csv')))
        new_files = current_files - existing_files

        if new_files:
            # æ‰¾åˆ°æœ€æ–°ä¿®æ”¹çš„æ–‡ä»¶
            newest_file = max(new_files, key=os.path.getctime)
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä»åœ¨ä¸‹è½½ï¼ˆ.crdownloadæ‰©å±•åï¼‰
            if ".crdownload" in newest_file or newest_file.endswith(".tmp"):
                newest_file = None  # å¦‚æœè¿˜åœ¨ä¸‹è½½ï¼Œåˆ™ç»§ç»­ç­‰å¾…
                time.sleep(1)
                continue
            print(f"  æ£€æµ‹åˆ°æ–°æ–‡ä»¶: {os.path.basename(newest_file)}")
            break
        time.sleep(1)

    if not newest_file:
        print(f"  [é”™è¯¯] åœ¨ {timeout} ç§’å†…æœªæ‰¾åˆ°ä¸º '{report_name}' ä¸‹è½½çš„æ–°æ–‡ä»¶ï¼è„šæœ¬å°†ç»ˆæ­¢ã€‚")
        return False

    today_str = date.today().strftime('%Y-%m-%d')
    new_filename = f"download_{report_name}_{today_str}.csv"
    new_filepath = os.path.join(download_path, new_filename)

    if os.path.exists(new_filepath):
        os.remove(new_filepath)
        print(f"  å‘ç°æ—§çš„åŒåæ–‡ä»¶ï¼Œå·²åˆ é™¤: {new_filename}")

    os.rename(newest_file, new_filepath)
    print(f"  [æˆåŠŸ] æ–‡ä»¶å·²é‡å‘½åä¸º: {new_filename}")
    return True


# --- ä¸»ç¨‹åº ---
print("--- å…¨èƒ½æ•°æ®ä¸‹è½½å™¨å¼€å§‹è¿è¡Œ ---")
s = Service(CHROMEDRIVER_PATH)
chrome_options = Options()
# (ä¼ªè£…é€‰é¡¹)
chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
chrome_options.add_experimental_option('useAutomationExtension', False)
chrome_options.add_argument(
    'user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36')
chrome_options.add_argument('--disable-blink-features=AutomationControlled')

try:
    driver = webdriver.Chrome(service=s, options=chrome_options)
    wait = WebDriverWait(driver, 20)
    driver.get(LOGIN_URL)

    # (ç™»å½•)
    print("é¡µé¢åŠ è½½ä¸­ï¼Œç­‰å¾…ç™»å½•æ¡†...")
    wait.until(EC.presence_of_element_located((By.XPATH, "//input[@placeholder='è´¦æˆ·']"))).send_keys(USERNAME)
    driver.find_element(By.XPATH, "//input[@placeholder='å¯†ç ']").send_keys(PASSWORD)
    driver.find_element(By.XPATH, "//button[contains(., 'ç™»å½•')]").click()

    # (æ‰‹åŠ¨éªŒè¯)
    print("\n" + "=" * 50 + "\nè„šæœ¬å·²æš‚åœï¼è¯·æ‰‹åŠ¨è¾“å…¥è°·æ­ŒéªŒè¯ç å¹¶å®Œæˆç™»å½•ã€‚")
    input("ç™»å½•æˆåŠŸåï¼Œè¯·å›åˆ°æ­¤çª—å£ï¼ŒæŒ‰ Enter (å›è½¦) é”®ç»§ç»­...")
    print("\n" + "=" * 50 + "\nè„šæœ¬å·²æ¢å¤ï¼Œå¼€å§‹æ‰¹é‡ä¸‹è½½æ‰€æœ‰æ•°æ®æº...")

    # æŠ¥è¡¨åˆ—è¡¨ä¿æŒä¸å˜
    reports_to_download = [
        {"name": "æ¸ é“æŠ¥è¡¨",
         "url": "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/stat/dailySummaryChannel"},
        {"name": "è¿è¥æŠ¥è¡¨",
         "url": "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/stat/operateDaily"},
        {"name": "é¦–å……ç”¨æˆ·åˆ†æ",
         "url": "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/stat/userAnalysis"},
        {"name": "ç”¨æˆ·ç•™å­˜",
         "url": "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/stat/userRetentionLog"},
        {"name": "æ–°å¢ç”¨æˆ·LTV",
         "url": "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/stat/userLtvLog"}
    ]

    downloads_path = os.path.join(os.path.expanduser('~'), 'Downloads')

    for report in reports_to_download:
        print(f"\n--- æ­£åœ¨å¤„ç†: {report['name']} ---")

        # 1. ç›´æ¥è·³è½¬åˆ°æŠ¥è¡¨é¡µé¢
        print(f"  ç›´æ¥è·³è½¬åˆ°é¡µé¢...")
        driver.get(report['url'])

        # [é€»è¾‘ä¿®æ­£] 2. ç›´æ¥ç‚¹å‡»ã€è¿‘90å¤©ã€‘å¿«æ·æŒ‰é’®
        print("  ç‚¹å‡»ã€è¿‘90å¤©ã€‘å¿«æ·æŒ‰é’®...")
        try:
            # ä½¿ç”¨æ›´ç²¾ç¡®çš„XPATHæ¥å®šä½æŒ‰é’®
            ninety_days_button = wait.until(EC.element_to_be_clickable((By.XPATH,
                                                                        "//span[contains(@class, 'arco-tabs-tab-title') and text()='è¿‘90å¤©'] | //span[text()='è¿‘90å¤©']")))
            driver.execute_script("arguments[0].click();", ninety_days_button)
            print("  å·²ç‚¹å‡»ã€è¿‘90å¤©ã€‘ï¼Œç­‰å¾…é¡µé¢å“åº”...")
            time.sleep(3)  # ç­‰å¾…3ç§’è®©é¡µé¢ä¸Šçš„æ—¥æœŸå’Œæ•°æ®è¯·æ±‚å‘å‡º
        except Exception as e:
            print(f"  [é”™è¯¯] æœªèƒ½ç‚¹å‡»ã€è¿‘90å¤©ã€‘æŒ‰é’®: {e}ã€‚è¯·æ£€æŸ¥é¡µé¢å…ƒç´ æ˜¯å¦å­˜åœ¨ã€‚")
            continue

        # 3. ç‚¹å‡»â€œæŸ¥è¯¢â€å¹¶ç­‰å¾…
        print("  æ­£åœ¨ç‚¹å‡»'æŸ¥è¯¢'æŒ‰é’®...")
        try:
            query_button = wait.until(EC.element_to_be_clickable((By.XPATH, "//button[contains(., 'æŸ¥è¯¢')]")))
            driver.execute_script("arguments[0].click();", query_button)
            print("  ç­‰å¾…æ–°æ•°æ®åŠ è½½ï¼ˆ15ç§’ï¼‰...")
            time.sleep(15)
        except Exception:
            print("  [è­¦å‘Š] æœªæ‰¾åˆ°'æŸ¥è¯¢'æŒ‰é’®ï¼Œç›´æ¥ç»§ç»­...")
            time.sleep(5)

        # 4. è®°å½•ä¸‹è½½å‰çš„æ–‡ä»¶çŠ¶æ€å¹¶å¯¼å‡º
        existing_files = set(
            glob.glob(os.path.join(downloads_path, '*.xlsx')) + glob.glob(os.path.join(downloads_path, '*.csv')))

        print("  æ­£åœ¨ç‚¹å‡»'å¯¼å‡º'æŒ‰é’®...")
        try:
            export_button = wait.until(EC.element_to_be_clickable((By.XPATH, "//button[contains(., 'å¯¼å‡º')]")))
            driver.execute_script("arguments[0].click();", export_button)
        except Exception as e:
            print(f"  [é”™è¯¯] ç‚¹å‡»'å¯¼å‡º'æŒ‰é’®å¤±è´¥: {e}")
            continue

        # 5. æŸ¥æ‰¾å¹¶é‡å‘½åæ–‡ä»¶
        if not find_and_rename_newest_file(downloads_path, report['name'], existing_files):
            break  # å¦‚æœæŸä¸ªæ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œåˆ™åœæ­¢åç»­æ“ä½œ

    print("\n" + "=" * 50)
    print("ğŸ‰ å…¨éƒ¨æ•°æ®æºä¸‹è½½å®Œæˆï¼")
    print("=" * 50)

except Exception as e:
    print(f"\nè„šæœ¬è¿è¡Œä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯: {e}")

finally:
    if 'driver' in locals() and driver:
        driver.quit()
    print("--- è„šæœ¬è¿è¡Œç»“æŸ ---")


import time
import os
import glob
from datetime import date
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options

# ==================== é…ç½®åŒº ====================
CHROMEDRIVER_PATH = r"C:\Users\User\Downloads\chromedriver-win64\chromedriver-win64\chromedriver.exe"
LOGIN_URL = "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/login"
USERNAME = "Touhou002"
PASSWORD = "123456"
# ================================================

def find_and_rename_newest_file(download_path, report_name, existing_files):
    """æŸ¥æ‰¾æœ€æ–°ä¸‹è½½çš„æ–‡ä»¶å¹¶æ ¹æ®æŠ¥è¡¨åç§°é‡å‘½å"""
    print(f"  ç­‰å¾… '{report_name}' æ–‡ä»¶ä¸‹è½½å®Œæˆ...")
    time.sleep(15)
    
    current_files = set(glob.glob(os.path.join(download_path, '*.xlsx')) + glob.glob(os.path.join(download_path, '*.csv')))
    new_files = current_files - existing_files
    
    if not new_files:
        print(f"  [è­¦å‘Š] æœªæ‰¾åˆ°ä¸º '{report_name}' ä¸‹è½½çš„æ–°æ–‡ä»¶ï¼")
        return
    
    newest_file = new_files.pop()
    today_str = date.today().strftime('%Y-%m-%d')
    new_filename = f"download_{report_name}_{today_str}.csv"
    new_filepath = os.path.join(download_path, new_filename)
    
    if os.path.exists(new_filepath): os.remove(new_filepath)
    os.rename(newest_file, new_filepath)
    print(f"  [æˆåŠŸ] æ–‡ä»¶å·²é‡å‘½åä¸º: {new_filename}")

# --- ä¸»ç¨‹åº ---
print("--- å…¨èƒ½æ•°æ®ä¸‹è½½å™¨å¼€å§‹è¿è¡Œ ---")
s = Service(CHROMEDRIVER_PATH)
chrome_options = Options()
# (ä¼ªè£…é€‰é¡¹)
chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
chrome_options.add_experimental_option('useAutomationExtension', False)
chrome_options.add_argument('user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36')
chrome_options.add_argument('--disable-blink-features=AutomationControlled')

try:
    driver = webdriver.Chrome(service=s, options=chrome_options)
    wait = WebDriverWait(driver, 20)
    driver.get(LOGIN_URL)
    
    # (ç™»å½•)
    print("é¡µé¢åŠ è½½ä¸­ï¼Œç­‰å¾…ç™»å½•æ¡†...")
    wait.until(EC.presence_of_element_located((By.XPATH, "//input[@placeholder='è´¦æˆ·']"))).send_keys(USERNAME)
    driver.find_element(By.XPATH, "//input[@placeholder='å¯†ç ']").send_keys(PASSWORD)
    driver.find_element(By.XPATH, "//button[contains(., 'ç™»å½•')]").click()
    
    # (æ‰‹åŠ¨éªŒè¯)
    print("\n" + "="*50 + "\nè„šæœ¬å·²æš‚åœï¼è¯·æ‰‹åŠ¨è¾“å…¥è°·æ­ŒéªŒè¯ç å¹¶å®Œæˆç™»å½•ã€‚")
    input("ç™»å½•æˆåŠŸåï¼Œè¯·å›åˆ°æ­¤çª—å£ï¼ŒæŒ‰ Enter (å›è½¦) é”®ç»§ç»­...")
    print("\n" + "="*50 + "\nè„šæœ¬å·²æ¢å¤ï¼Œå¼€å§‹æ‰¹é‡ä¸‹è½½æ‰€æœ‰æ•°æ®æº...")

    # å®šä¹‰æˆ‘ä»¬éœ€è¦ä¸‹è½½çš„æ‰€æœ‰æŠ¥è¡¨
    reports_to_download = [
        {"name": "æ¸ é“æŠ¥è¡¨", "url": "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/stat/dailySummaryChannel"},
        {"name": "è¿è¥æŠ¥è¡¨", "url": "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/stat/operateDaily"}, # å‡è®¾è¿™æ˜¯æ—¥è¿è¥æŠ¥è¡¨çš„URL
        {"name": "ç”¨æˆ·ç•™å­˜", "url": "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/stat/userRetentionLog"}, # å‡è®¾è¿™æ˜¯ç”¨æˆ·ç•™å­˜çš„URL
        {"name": "æ–°å¢ç”¨æˆ·LTV", "url": "https://admindmgkgir666.epiwin24admgf4f73402ghudsd9k1vie9g82h9.com/#/stat/userLtvLog"} # å‡è®¾è¿™æ˜¯LTVçš„URL
    ]
    
    downloads_path = os.path.join(os.path.expanduser('~'), 'Downloads')

    for report in reports_to_download:
        print(f"\n--- æ­£åœ¨å¤„ç†: {report['name']} ---")
        
        # 1. ç›´æ¥è·³è½¬åˆ°æŠ¥è¡¨é¡µé¢
        print(f"  ç›´æ¥è·³è½¬åˆ°é¡µé¢...")
        driver.get(report['url'])
        
        # 2. ç‚¹å‡»ã€è¿‘30å¤©ã€‘æŒ‰é’®
        print("  ç‚¹å‡»ã€è¿‘30å¤©ã€‘å¿«æ·æŒ‰é’®...")
        try:
            wait.until(EC.element_to_be_clickable((By.XPATH, "//span[text()='è¿‘30å¤©']"))).click()
        except Exception:
            # å¦‚æœæ²¡æœ‰è¿‘30å¤©æŒ‰é’®ï¼Œå°±æ‰‹åŠ¨è®¾ç½®æ—¥æœŸï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
            print("  æœªæ‰¾åˆ°ã€è¿‘30å¤©ã€‘æŒ‰é’®ï¼Œå°è¯•æ‰‹åŠ¨è®¾ç½®æ—¥æœŸ...")
            end_date = date.today() - timedelta(days=1)
            start_date = end_date - timedelta(days=29)
            start_date_str = start_date.strftime('%Y-%m-%d')
            end_date_str = end_date.strftime('%Y-%m-%d')
            start_date_input = wait.until(EC.presence_of_element_located((By.XPATH, "//input[@placeholder='å¼€å§‹æ—¥æœŸ']")))
            end_date_input = driver.find_element(By.XPATH, "//input[@placeholder='ç»“æŸæ—¥æœŸ']")
            start_date_input.clear(); time.sleep(0.5); start_date_input.send_keys(start_date_str)
            end_date_input.clear(); time.sleep(0.5); end_date_input.send_keys(end_date_str)
            driver.find_element(By.XPATH, "//body").click()

        time.sleep(1)
        
        # 3. ç‚¹å‡»â€œæŸ¥è¯¢â€å¹¶ç­‰å¾…
        print("  æ­£åœ¨ç‚¹å‡»'æŸ¥è¯¢'æŒ‰é’®...")
        try:
            query_button = wait.until(EC.presence_of_element_located((By.XPATH, "//button[contains(., 'æŸ¥è¯¢')]")))
            driver.execute_script("arguments[0].click();", query_button)
            print("  ç­‰å¾…æ–°æ•°æ®åŠ è½½ï¼ˆ10ç§’ï¼‰...")
            time.sleep(10) 
        except Exception:
            print("  æœªæ‰¾åˆ°'æŸ¥è¯¢'æŒ‰é’®ï¼Œç›´æ¥ç»§ç»­...")
            time.sleep(5)
            
        # 4. è®°å½•ä¸‹è½½å‰çš„æ–‡ä»¶çŠ¶æ€å¹¶å¯¼å‡º
        existing_files = set(glob.glob(os.path.join(downloads_path, '*.xlsx')) + glob.glob(os.path.join(downloads_path, '*.csv')))
        
        print("  æ­£åœ¨ç‚¹å‡»'å¯¼å‡º'æŒ‰é’®...")
        export_button = wait.until(EC.presence_of_element_located((By.XPATH, "//button[contains(., 'å¯¼å‡º')]")))
        driver.execute_script("arguments[0].click();", export_button)
        
        # 5. æŸ¥æ‰¾å¹¶é‡å‘½åæ–‡ä»¶
        find_and_rename_newest_file(downloads_path, report['name'], existing_files)

    print("\n" + "="*50)
    print("ğŸ‰ å…¨éƒ¨æ•°æ®æºä¸‹è½½æˆåŠŸï¼")
    print("="*50)

except Exception as e:
    print(f"\nè„šæœ¬è¿è¡Œä¸­å‘ç”Ÿé”™è¯¯: {e}")

finally:
    if 'driver' in locals() and driver:
        driver.quit()
    print("--- è„šæœ¬è¿è¡Œç»“æŸ ---")
